{"id":"blink-t6o","title":"Learning: Authentication patterns - OAuth2, NextAuth, route-level authorization","description":"## Summary\nReference document for authentication patterns used in Blink, discovered during codebase exploration.\n\n## Key Learnings\n\n### 1. OAuth2 in KYC Flow\n- OAuth2 allows third-party apps (blink-kyc) to access resources on behalf of users WITHOUT sharing credentials\n- Authorization Code flow: User authorizes → gets CODE → server exchanges CODE + CLIENT_SECRET for TOKEN\n- CLIENT_SECRET is critical because the authorization code travels through browser (interceptable)\n- Components: Hydra (authorization server), Oathkeeper (validates tokens at API gateway)\n\n### 2. Admin-Panel Authentication\n- Uses **NextAuth.js v4** with Google OAuth2\n- Two providers: Google (production), Credentials (dev only with admin/admin)\n- Authorization via email whitelist (`AUTHORIZED_EMAILS` env var)\n- Session stored in HTTP-only cookies\n- API calls: Apollo Client forwards cookies → Oathkeeper → Kratos validates → Admin GraphQL API\n\n### 3. Route-Level Authorization Options\n\n| Approach | Best For | Limitations |\n|----------|----------|-------------|\n| **Env-based lists** | \u003c10 admins, rarely changes | Requires redeploy, no audit trail |\n| **Database roles** | 10-50 users, dynamic access | More code, DB dependency |\n| **Google Groups** | Google Workspace orgs | Requires API setup |\n| **External authz (Keto/OPA)** | Complex policies, enterprise | Additional service |\n\n### 4. When Env-Based Auth is Acceptable\n- Small team (\u003c10 admins)\n- Rarely changing access lists\n- Admin-only tools\n- MVP/early stage\n- When \"config as code\" is desired for auditability\n\n### 5. When to Graduate to Database/IdP\n- Scalability issues (long comma-separated env vars)\n- Need dynamic updates without redeployment\n- Audit trail requirements\n- Self-service admin management needed\n\n## Files Referenced\n- `apps/admin-panel/app/api/auth/[...nextauth]/options.ts` - Auth config\n- `apps/admin-panel/middleware.ts` - Route protection\n- `apps/admin-panel/env.ts` - Environment variables\n- `docs/request-flow-and-authentication.md` - OAuth2 flow diagrams","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-19T10:56:26.386698+07:00","updated_at":"2025-12-19T10:56:54.704513+07:00","closed_at":"2025-12-19T10:56:54.704513+07:00","close_reason":"Learning documented for future reference"}
